@RestResource(urlMapping='/Immofinder')
global with sharing class RestImmofinder  {
    @HttpPost
    global static ImmofinderData show(Id userId, Boolean subQuery) {
        ImmofinderData immofinderData = new ImmofinderData(userId, subQuery);
        return immofinderData;
    }

    global class ImmofinderData {

        List<Property__c> properties = new List<Property__c>();
        List<Appartment__c> apps = new List<Appartment__c>();
        List<PresaleApartment__c> presaleApps = new List<PresaleApartment__c>();
        List<PresaleReservierung__c> presaleReservations = new List<PresaleReservierung__c>();
        List<Nachtrag__c> nachtraege = new List<Nachtrag__c>();
        KfW_Konditionen__c kfwKonditionen = new KfW_Konditionen__c();
        List<Exklusiv_im_Immofinder__c> exklusivImImmofinder = [SELECT Account__c, Immobilie__c FROM Exklusiv_im_Immofinder__c];
        List<Property__c> exklusivObjekte = new List<Property__c>();
        List<Property_User_Junction__c> userJunctions = new List<Property_User_Junction__c>();

        Integer sizeProperties;
        public ImmofinderData (Id userId, Boolean subQuery) {
            Realty_User__c user = [SELECT Id, Type__c, AccountId__c FROM Realty_User__c WHERE Id =: userId];

            List<Provisionsverhandlung__c> provisionsVerhandlungen = [SELECT Immobilie__c FROM Provisionsverhandlung__c WHERE Account__c =: user.AccountId__c];

                    // Exklusiv Objekte und Objekte aus Provisionsverhandlungen
            Set<Id> exklusivObjekteIds = new Set<Id>();
            for(Exklusiv_im_Immofinder__c exklusiv:exklusivImImmofinder) {
                exklusivObjekteIds.add(exklusiv.Immobilie__c);
            }
            for(Provisionsverhandlung__c provisionsVerhandlung:provisionsVerhandlungen) {
                exklusivObjekteIds.add(provisionsVerhandlung.Immobilie__c);
            }
            if(subQuery == false) {
                properties = getProperties(user);
                List<Id> propertyIds = new List<Id>();
                for(Property__c prop:properties) {
                    propertyIds.add(prop.Id);
                }
                apps = getApps(propertyIds, exklusivObjekteIds);
                presaleApps = getPresaleApps(propertyIds, exklusivObjekteIds);
                presaleReservations = getPresaleReservations(propertyIds, exklusivObjekteIds);
            } else {
                properties = getPropertiesWithApps(user);
            }

            sizeProperties = properties.size();
            try {
                kfwKonditionen = [SELECT Zins_4_10_Jahre_10_Jahre_Zinsbindung__c,Zins_11_20_Jahre_10_Jahre_Zinsbindung__c,Zins_11_20_Jahre_20_Jahre_Zinsbindung__c,Zins_21_30_Jahre_10_Jahre_Zinsbindung__c,Zins_21_30_Jahre_20_Jahre_Zinsbindung__c FROM KfW_Konditionen__c WHERE Name = 'Kfw Konditionen 2017' LIMIT 1];
            } catch(Exception e)
            {

            }
            for(Nachtrag__c nachtrag:[SELECT Immobilie__c, E_Mail_Verification_Code__c, E_Mail_Opt_In__c FROM Nachtrag__c WHERE Immo_Benutzer__c =: userId]) {
                nachtraege.add(nachtrag);
            }

            try {
                exklusivObjekte = [SELECT Id, Vertrieben_durch__c, Notar__r.Account.Name, In_Vorschau__c, Vorschau_Apartments__c, Vorschau_Fertigstellung__c, Vorschau_Fl_che__c, Vorschau_Kaufpreis__c, Vorschau_Rendite__c, Afa_Facility__c, Afa_Outdoor__c, Afa_Building_Shares__c, In_HypoServ__c, Immorechner_Deaktivieren__c, Finanzierungsbeginn__c, Status_Teilungserkl_rung__c, Hinweis_Kaufpreiszahlung__c, Projektbeauftragte__c, Projektbeauftragte__r.Name, Projektbeauftragte__r.Contact__r.Email, Projektbeauftragte__r.Bild_Datei__c, Projektbeauftragte__r.Foto_URL__c, Projektbeauftragte__r.Telefonnummer__c,Beurkundbar_ab__c,Projektbeauftragte_Hyposerv__c, Projektbeauftragte_Hyposerv__r.Name, Projektbeauftragte_Hyposerv__r.Contact__r.Email, Projektbeauftragte_Hyposerv__r.Bild_Datei__c, Projektbeauftragte_Hyposerv__r.Foto_URL__c, Projektbeauftragte_Hyposerv__r.Telefonnummer__c,Status_Grundrisse__c,Nachtrag_n_tig__c,Nachtrag_Provision__c, Text_Nachtrag_Provision__c, Wert_Einrichtung__c,Building_Share_Value__c,Value_Of_Outdoor__c, Finanzierungslinie_Zinssatz__c, Finanzierungslinie_Zinsbindung__c, Finanzierungslinie_Laufzeit_max__c, Finanzierungslinie_Sondertilgung__c, Finanzierungslinie_Bereitstellungszins__c, Finanzierungslinie_Kaufpreis_max__c, Finanzierungslinie_Informationen__c,Status_Energieausweis__c,Status_Pachtvertrag__c,Status_Anschlusspachtvertrag__c,Status_Patronatserkl_rung__c,Status_Verwaltervertrag__c,Status_Kaufvertrag__c,Status_Grunddienstbarkeit__c,Status_Baubeschreibung__c,Status_Exposee__c,Status_Factsheet__c,Name, Fl_che_ab__c, Finanzierung_Details__c, Fl_che_bis__c, Min_Rendite__c, Max_Rendite__c, Rendite_in__c, Preis_ab__c, Preis_bis__c, Property__c, Bauart__c, Completion__c, MaBV__c, Infozeile_1__c, Arrival__c, Objektvideo_Link__c, Logo__c, Collection_Id_Hyposerv__c, Collection_Id__c, Provisionsbedingung_Check__c, Description__c, Lagebeschreibung__c, Street__c, Zip_Code__c, Place__c, State__c, Teaser_Highlight_1__c, Teaser_Highlight_2__c, Teaser_Highlight_3__c, Betreiber__r.Id, Betreiber__r.Name, Betreiber__r.Stra_e__c, Betreiber__r.PLZ__c, Betreiber__r.Stadt__c, Betreiber__r.Betreiber_Logo__c, Betreiber__r.Betreiberinformationen__c, Real_Estate_Transfer_Tax__c, Notary_And_Court_Rate__c, (SELECT Id, Name, Area_sq_m__c, Purchase_Price__c, Purchase_Price_sq_m__c, Status__c FROM Appartments__r ORDER BY Name) FROM Property__c WHERE Id in :exklusivObjekteIds ORDER BY Name];
            } catch(Exception e) {}

            userJunctions = [SELECT User__c, Immobilie__c, Google_Drive_Id__c FROM Property_User_Junction__c WHERE User__c =: userId];
        }

        private List<Property__c> getProperties(Realty_User__c user) {
            List<Property__c> properties = new List<Property__c>();
            if(user.Type__c == 'Admin') {
                properties = [SELECT Id, Notar__r.Account.Name, InstandhaltungOnce__c ,In_Vorschau__c, Vorschau_Apartments__c, Vorschau_Fertigstellung__c, Vorschau_Fl_che__c, Vorschau_Kaufpreis__c, Vorschau_Rendite__c, Afa_Facility__c, Afa_Outdoor__c, Afa_Building_Shares__c, In_HypoServ__c, Immorechner_Deaktivieren__c, Finanzierungsbeginn__c, Status_Teilungserkl_rung__c, Hinweis_Kaufpreiszahlung__c, Projektbeauftragte__c, Projektbeauftragte__r.Name, Projektbeauftragte__r.Contact__r.Email, Projektbeauftragte__r.Bild_Datei__c, Projektbeauftragte__r.Foto_URL__c, Projektbeauftragte__r.Telefonnummer__c,Beurkundbar_ab__c,Projektbeauftragte_Hyposerv__c, Projektbeauftragte_Hyposerv__r.Name, Projektbeauftragte_Hyposerv__r.Contact__r.Email, Projektbeauftragte_Hyposerv__r.Bild_Datei__c, Projektbeauftragte_Hyposerv__r.Foto_URL__c, Projektbeauftragte_Hyposerv__r.Telefonnummer__c,Status_Grundrisse__c,Nachtrag_n_tig__c,Nachtrag_Provision__c, Text_Nachtrag_Provision__c, Wert_Einrichtung__c,Building_Share_Value__c,Value_Of_Outdoor__c, Finanzierungslinie_Zinssatz__c, Finanzierungslinie_Zinsbindung__c, Finanzierungslinie_Laufzeit_max__c, Finanzierungslinie_Sondertilgung__c, Finanzierungslinie_Bereitstellungszins__c, Finanzierungslinie_Kaufpreis_max__c, Finanzierungslinie_Informationen__c,Status_Energieausweis__c,Status_Pachtvertrag__c,Status_Anschlusspachtvertrag__c,Status_Patronatserkl_rung__c,Status_Verwaltervertrag__c,Status_Kaufvertrag__c,Status_Grunddienstbarkeit__c,Status_Baubeschreibung__c,Status_Exposee__c,Status_Factsheet__c,Name, Fl_che_ab__c, Finanzierung_Details__c, Fl_che_bis__c, Min_Rendite__c, Max_Rendite__c, Rendite_in__c, Preis_ab__c, Preis_bis__c, Property__c, Bauart__c, Completion__c, MaBV__c, Infozeile_1__c, Arrival__c, Objektvideo_Link__c, Logo__c, Collection_Id_Hyposerv__c, Collection_Id__c, Provisionsbedingung_Check__c, Description__c, Lagebeschreibung__c, Street__c, Zip_Code__c, Place__c, State__c, Teaser_Highlight_1__c, Teaser_Highlight_2__c, Teaser_Highlight_3__c, Betreiber__r.Id, Betreiber__r.Name, Betreiber__r.Stra_e__c, Betreiber__r.PLZ__c, Betreiber__r.Stadt__c, Betreiber__r.Betreiber_Logo__c, Betreiber__r.Betreiberinformationen__c, Real_Estate_Transfer_Tax__c, Notary_And_Court_Rate__c FROM Property__c WHERE (Status_Reason__c = 'Aktiv') ORDER BY Name];
            } else if(user.Type__c == 'Normal Agency' || user.Type__c == 'Manager Agency') {
                List<Property__c> propsNormal = [SELECT Id, Vertrieben_durch__c, Notar__r.Account.Name, InstandhaltungOnce__c ,In_Vorschau__c, Vorschau_Apartments__c, Vorschau_Fertigstellung__c, Vorschau_Fl_che__c, Vorschau_Kaufpreis__c, Vorschau_Rendite__c, Afa_Facility__c, Afa_Outdoor__c, Afa_Building_Shares__c, In_HypoServ__c, Immorechner_Deaktivieren__c, Finanzierungsbeginn__c, Status_Teilungserkl_rung__c, Hinweis_Kaufpreiszahlung__c, Projektbeauftragte__c, Projektbeauftragte__r.Name, Projektbeauftragte__r.Contact__r.Email, Projektbeauftragte__r.Bild_Datei__c, Projektbeauftragte__r.Foto_URL__c, Projektbeauftragte__r.Telefonnummer__c,Projektbeauftragte_Hyposerv__c, Projektbeauftragte_Hyposerv__r.Name, Projektbeauftragte_Hyposerv__r.Contact__r.Email, Projektbeauftragte_Hyposerv__r.Bild_Datei__c, Projektbeauftragte_Hyposerv__r.Foto_URL__c, Projektbeauftragte_Hyposerv__r.Telefonnummer__c,Status_Grundrisse__c,Beurkundbar_ab__c,Nachtrag_n_tig__c, Text_Nachtrag_Provision__c, Wert_Einrichtung__c,Building_Share_Value__c,Value_Of_Outdoor__c, Nachtrag_Provision__c,Finanzierungslinie_Zinssatz__c, Finanzierungslinie_Zinsbindung__c, Finanzierungslinie_Laufzeit_max__c, Finanzierungslinie_Sondertilgung__c, Finanzierungslinie_Bereitstellungszins__c, Finanzierungslinie_Kaufpreis_max__c, Finanzierungslinie_Informationen__c,Status_Energieausweis__c,Status_Pachtvertrag__c,Status_Anschlusspachtvertrag__c,Status_Patronatserkl_rung__c,Status_Verwaltervertrag__c,Status_Kaufvertrag__c,Status_Grunddienstbarkeit__c,Status_Baubeschreibung__c,Status_Exposee__c,Status_Factsheet__c, Name, Fl_che_ab__c, Finanzierung_Details__c, Fl_che_bis__c, Min_Rendite__c, Max_Rendite__c, Rendite_in__c, Preis_ab__c, Preis_bis__c, Property__c, Bauart__c, Completion__c, MaBV__c, Infozeile_1__c, Arrival__c, Objektvideo_Link__c, Logo__c, Collection_Id_Hyposerv__c, Collection_Id__c, Provisionsbedingung_Check__c, Description__c, Lagebeschreibung__c, Street__c, Zip_Code__c, Place__c, State__c, Teaser_Highlight_1__c, Teaser_Highlight_2__c, Teaser_Highlight_3__c, Betreiber__r.Id, Betreiber__r.Name, Betreiber__r.Stra_e__c, Betreiber__r.PLZ__c, Betreiber__r.Stadt__c, Betreiber__r.Betreiber_Logo__c, Betreiber__r.Betreiberinformationen__c, Real_Estate_Transfer_Tax__c, Notary_And_Court_Rate__c FROM Property__c WHERE (Is_Public__c = true AND Status_Reason__c = 'Aktiv') ORDER BY Name];

                List<Property__c> propsNormal2 = [SELECT Id, Vertrieben_durch__c, Notar__r.Account.Name, InstandhaltungOnce__c ,In_Vorschau__c, Vorschau_Apartments__c, Vorschau_Fertigstellung__c, Vorschau_Fl_che__c, Vorschau_Kaufpreis__c, Vorschau_Rendite__c, Afa_Facility__c, Afa_Outdoor__c, Afa_Building_Shares__c, In_HypoServ__c, Immorechner_Deaktivieren__c, Finanzierungsbeginn__c, Status_Teilungserkl_rung__c, Hinweis_Kaufpreiszahlung__c, Projektbeauftragte__c, Projektbeauftragte__r.Name, Projektbeauftragte__r.Contact__r.Email, Projektbeauftragte__r.Bild_Datei__c, Projektbeauftragte__r.Foto_URL__c, Projektbeauftragte__r.Telefonnummer__c,Projektbeauftragte_Hyposerv__c, Projektbeauftragte_Hyposerv__r.Name, Projektbeauftragte_Hyposerv__r.Contact__r.Email, Projektbeauftragte_Hyposerv__r.Bild_Datei__c, Projektbeauftragte_Hyposerv__r.Foto_URL__c, Projektbeauftragte_Hyposerv__r.Telefonnummer__c,Status_Grundrisse__c,Beurkundbar_ab__c,Nachtrag_n_tig__c, Text_Nachtrag_Provision__c, Wert_Einrichtung__c,Building_Share_Value__c,Value_Of_Outdoor__c, Nachtrag_Provision__c,Finanzierungslinie_Zinssatz__c, Finanzierungslinie_Zinsbindung__c, Finanzierungslinie_Laufzeit_max__c, Finanzierungslinie_Sondertilgung__c, Finanzierungslinie_Bereitstellungszins__c, Finanzierungslinie_Kaufpreis_max__c, Finanzierungslinie_Informationen__c,Status_Energieausweis__c,Status_Pachtvertrag__c,Status_Anschlusspachtvertrag__c,Status_Patronatserkl_rung__c,Status_Verwaltervertrag__c,Status_Kaufvertrag__c,Status_Grunddienstbarkeit__c,Status_Baubeschreibung__c,Status_Exposee__c,Status_Factsheet__c, Name, Fl_che_ab__c, Finanzierung_Details__c, Fl_che_bis__c, Min_Rendite__c, Max_Rendite__c, Rendite_in__c, Preis_ab__c, Preis_bis__c, Property__c, Bauart__c, Completion__c, MaBV__c, Infozeile_1__c, Arrival__c, Objektvideo_Link__c, Logo__c, Collection_Id_Hyposerv__c, Collection_Id__c, Provisionsbedingung_Check__c, Description__c, Lagebeschreibung__c, Street__c, Zip_Code__c, Place__c, State__c, Teaser_Highlight_1__c, Teaser_Highlight_2__c, Teaser_Highlight_3__c, Betreiber__r.Id, Betreiber__r.Name, Betreiber__r.Stra_e__c, Betreiber__r.PLZ__c, Betreiber__r.Stadt__c, Betreiber__r.Betreiber_Logo__c, Betreiber__r.Betreiberinformationen__c, Real_Estate_Transfer_Tax__c, Notary_And_Court_Rate__c FROM Property__c WHERE Id in (SELECT Immobilie__c FROM Exklusiv_im_ImmoFinder__c WHERE Account_ID__c = :user.AccountId__c) ORDER BY Name];

                Set<Property__c> propsSet = new Set<Property__c>();
                propsSet.addAll(propsNormal);
                propsSet.addAll(propsNormal2);
                properties.addAll(propsSet);
                properties.sort();
            } else {
                properties = [SELECT Id, Vertrieben_durch__c, Notar__r.Account.Name, InstandhaltungOnce__c ,In_Vorschau__c, Vorschau_Apartments__c, Vorschau_Fertigstellung__c, Vorschau_Fl_che__c, Vorschau_Kaufpreis__c, Vorschau_Rendite__c, Afa_Facility__c, Afa_Outdoor__c, Afa_Building_Shares__c, In_HypoServ__c, Immorechner_Deaktivieren__c, Finanzierungsbeginn__c, Status_Teilungserkl_rung__c, Hinweis_Kaufpreiszahlung__c, Projektbeauftragte__c, Projektbeauftragte__r.Name, Projektbeauftragte__r.Contact__r.Email, Projektbeauftragte__r.Bild_Datei__c, Projektbeauftragte__r.Foto_URL__c, Projektbeauftragte__r.Telefonnummer__c,Projektbeauftragte_Hyposerv__c, Projektbeauftragte_Hyposerv__r.Name, Projektbeauftragte_Hyposerv__r.Contact__r.Email, Projektbeauftragte_Hyposerv__r.Bild_Datei__c, Projektbeauftragte_Hyposerv__r.Foto_URL__c, Projektbeauftragte_Hyposerv__r.Telefonnummer__c,Status_Grundrisse__c, Text_Nachtrag_Provision__c, Wert_Einrichtung__c,Building_Share_Value__c,Value_Of_Outdoor__c, Beurkundbar_ab__c,Nachtrag_n_tig__c,Nachtrag_Provision__c,Finanzierungslinie_Zinssatz__c, Finanzierungslinie_Zinsbindung__c, Finanzierungslinie_Laufzeit_max__c, Finanzierungslinie_Sondertilgung__c, Finanzierungslinie_Bereitstellungszins__c, Finanzierungslinie_Kaufpreis_max__c, Finanzierungslinie_Informationen__c,Status_Energieausweis__c,Status_Pachtvertrag__c,Status_Anschlusspachtvertrag__c,Status_Patronatserkl_rung__c,Status_Verwaltervertrag__c,Status_Kaufvertrag__c,Status_Grunddienstbarkeit__c,Status_Baubeschreibung__c,Status_Exposee__c,Status_Factsheet__c, Name, Fl_che_ab__c, Finanzierung_Details__c, Fl_che_bis__c, Min_Rendite__c, Max_Rendite__c, Rendite_in__c, Preis_ab__c, Preis_bis__c, Property__c, Bauart__c, Completion__c, MaBV__c, Infozeile_1__c, Arrival__c, Objektvideo_Link__c, Logo__c, Collection_Id_Hyposerv__c, Collection_Id__c, Provisionsbedingung_Check__c, Description__c, Lagebeschreibung__c, Street__c, Zip_Code__c, Place__c, State__c, Teaser_Highlight_1__c, Teaser_Highlight_2__c, Teaser_Highlight_3__c, Betreiber__r.Id, Betreiber__r.Name, Betreiber__r.Stra_e__c, Betreiber__r.PLZ__c, Betreiber__r.Stadt__c, Betreiber__r.Betreiber_Logo__c, Betreiber__r.Betreiberinformationen__c, Real_Estate_Transfer_Tax__c, Notary_And_Court_Rate__c FROM Property__c WHERE (Is_Public__c = true AND Status_Reason__c = 'Aktiv') ORDER BY Name];

            }
            return properties;
        }

        private List<Appartment__c> getApps(List<Id> propertyIds, Set<Id> exklusivObjekteIds) {
            List<Appartment__c> apps = [SELECT Id, Name, Rabatt_bis__c, Rabatt_in__c, Area_sq_m__c, Property__c, Purchase_Price__c, Purchase_Price_sq_m__c, Status__c, Monthly_Rent__c, Cost_Admin__c, Notary_And_Court_Costs_1_5__c, Real_Estate_Transfer_Tax__c, Maintenance_sqm__c, Land_Value__c, Value_of_OIutdoor__c, Net_asset_value__c, Value_Preservation__c, AFA_Einrichtung__c, Value_Unit__c, Value_Parking_Space__c, Maklercourtage__c, Other_Fees__c, Additional_Costs__c, Processing_Fee__c, Rent_Parking_Space__c, Ancillary_Costs_Monthly__c, Erbbauzins__c, Rental_Start__c, Repayment_Beginning__c, Rent_Increase_In__c, Rent_Increase_After_Years__c, Admin_Costs_Increase_In__c, Admin_Costs_Increase_After_Years__c,Value_Furniture__c, Wert_K_che__c, Instandhaltungskostenst_percent__c, Instandhaltung__c FROM Appartment__c WHERE Property__c in : propertyIds OR Property__c in : exklusivObjekteIds ORDER BY Name];
            return apps;
        }

        private List<PresaleApartment__c> getPresaleApps(List<Id> propertyIds, Set<Id> exklusivObjekteIds) {
            List<PresaleApartment__c> presaleApps = [SELECT Id, Name, Fl_che__c, Property__c, Kaufpreis__c, Miete_per_annum__c, Preis_pro_qm__c FROM PresaleApartment__c WHERE Property__c in : propertyIds OR Property__c in : exklusivObjekteIds ORDER BY Name];
            return presaleApps;
        }

        private List<PresaleReservierung__c> getPresaleReservations(List<Id> propertyIds, Set<Id> exklusivObjekteIds) {
            List<PresaleReservierung__c> reservations = [SELECT Id, Name, PresaleTeilobjekt__c, Property__c FROM PresaleReservierung__c WHERE Property__c in : propertyIds OR Property__c in : exklusivObjekteIds ORDER BY Name];
            return reservations;
        }

        private List<Property__c> getPropertiesWithApps(Realty_User__c user) {
            List<Property__c> properties = new List<Property__c>();
            if(user.Type__c == 'Admin') {
                properties = [SELECT Id,  Vertrieben_durch__c, Notar__r.Account.Name,InstandhaltungOnce__c ,In_Vorschau__c, Vorschau_Apartments__c, Vorschau_Fertigstellung__c, Vorschau_Fl_che__c, Vorschau_Kaufpreis__c, Vorschau_Rendite__c, Afa_Facility__c, Afa_Outdoor__c, Afa_Building_Shares__c, In_HypoServ__c, Immorechner_Deaktivieren__c, Status_Teilungserkl_rung__c, Hinweis_Kaufpreiszahlung__c, Projektbeauftragte__c, Projektbeauftragte__r.Name, Projektbeauftragte__r.Contact__r.Email, Projektbeauftragte__r.Bild_Datei__c, Projektbeauftragte__r.Foto_URL__c, Projektbeauftragte__r.Telefonnummer__c,Projektbeauftragte_Hyposerv__c, Projektbeauftragte_Hyposerv__r.Name, Projektbeauftragte_Hyposerv__r.Contact__r.Email, Projektbeauftragte_Hyposerv__r.Bild_Datei__c, Projektbeauftragte_Hyposerv__r.Foto_URL__c, Projektbeauftragte_Hyposerv__r.Telefonnummer__c,Status_Grundrisse__c, Text_Nachtrag_Provision__c, Wert_Einrichtung__c,Building_Share_Value__c,Value_Of_Outdoor__c, Beurkundbar_ab__c,Nachtrag_n_tig__c,Nachtrag_Provision__c,Finanzierungslinie_Zinssatz__c, Finanzierungslinie_Zinsbindung__c, Finanzierungslinie_Laufzeit_max__c, Finanzierungslinie_Sondertilgung__c, Finanzierungslinie_Bereitstellungszins__c, Finanzierungslinie_Kaufpreis_max__c, Finanzierungslinie_Informationen__c,Status_Energieausweis__c,Status_Pachtvertrag__c,Status_Anschlusspachtvertrag__c,Status_Patronatserkl_rung__c,Status_Verwaltervertrag__c,Status_Kaufvertrag__c,Status_Grunddienstbarkeit__c,Status_Baubeschreibung__c,Status_Exposee__c,Status_Factsheet__c, Name, Fl_che_ab__c, Finanzierung_Details__c, Fl_che_bis__c, Min_Rendite__c, Max_Rendite__c, Rendite_in__c, Preis_ab__c, Preis_bis__c, Property__c, Bauart__c, Completion__c, MaBV__c, Infozeile_1__c, Arrival__c, Objektvideo_Link__c, Logo__c, Collection_Id_Hyposerv__c, Collection_Id__c, Provisionsbedingung_Check__c, Description__c, Lagebeschreibung__c, Street__c, Zip_Code__c, Place__c, State__c, Teaser_Highlight_1__c, Teaser_Highlight_2__c, Teaser_Highlight_3__c, Betreiber__r.Id, Betreiber__r.Name, Betreiber__r.Stra_e__c, Betreiber__r.PLZ__c, Betreiber__r.Stadt__c, Betreiber__r.Betreiber_Logo__c, Betreiber__r.Betreiberinformationen__c, (SELECT Id, Name, Area_sq_m__c, Purchase_Price__c, Purchase_Price_sq_m__c, Status__c FROM Appartments__r ORDER BY Name) FROM Property__c WHERE (Status_Reason__c = 'Aktiv') ORDER BY Name];
            } else if(user.Type__c == 'Normal Agency' || user.Type__c == 'Manager Agency') {
                List<Property__c> propsNormal = [SELECT Id, Vertrieben_durch__c, Notar__r.Account.Name,InstandhaltungOnce__c ,In_Vorschau__c, Vorschau_Apartments__c, Vorschau_Fertigstellung__c, Vorschau_Fl_che__c, Vorschau_Kaufpreis__c, Vorschau_Rendite__c, Afa_Facility__c, Afa_Outdoor__c, Afa_Building_Shares__c, In_HypoServ__c, Immorechner_Deaktivieren__c, Finanzierungsbeginn__c, Status_Teilungserkl_rung__c, Hinweis_Kaufpreiszahlung__c, Projektbeauftragte__c, Projektbeauftragte__r.Name, Projektbeauftragte__r.Contact__r.Email, Projektbeauftragte__r.Bild_Datei__c, Projektbeauftragte__r.Foto_URL__c, Projektbeauftragte__r.Telefonnummer__c,Projektbeauftragte_Hyposerv__c, Projektbeauftragte_Hyposerv__r.Name, Projektbeauftragte_Hyposerv__r.Contact__r.Email, Projektbeauftragte_Hyposerv__r.Bild_Datei__c, Projektbeauftragte_Hyposerv__r.Foto_URL__c, Projektbeauftragte_Hyposerv__r.Telefonnummer__c, Text_Nachtrag_Provision__c, Wert_Einrichtung__c,Building_Share_Value__c,Value_Of_Outdoor__c, Beurkundbar_ab__c,Status_Grundrisse__c,Nachtrag_n_tig__c,Nachtrag_Provision__c,Finanzierungslinie_Zinssatz__c, Finanzierungslinie_Zinsbindung__c, Finanzierungslinie_Laufzeit_max__c, Finanzierungslinie_Sondertilgung__c, Finanzierungslinie_Bereitstellungszins__c, Finanzierungslinie_Kaufpreis_max__c, Finanzierungslinie_Informationen__c,Status_Energieausweis__c,Status_Pachtvertrag__c,Status_Anschlusspachtvertrag__c,Status_Patronatserkl_rung__c,Status_Verwaltervertrag__c,Status_Kaufvertrag__c,Status_Grunddienstbarkeit__c,Status_Baubeschreibung__c,Status_Exposee__c,Status_Factsheet__c, Name, Fl_che_ab__c, Finanzierung_Details__c, Fl_che_bis__c, Min_Rendite__c, Max_Rendite__c, Rendite_in__c, Preis_ab__c, Preis_bis__c, Property__c, Bauart__c, Completion__c, MaBV__c, Infozeile_1__c, Arrival__c, Objektvideo_Link__c, Logo__c, Collection_Id_Hyposerv__c, Collection_Id__c, Provisionsbedingung_Check__c, Description__c, Lagebeschreibung__c, Street__c, Zip_Code__c, Place__c, State__c, Teaser_Highlight_1__c, Teaser_Highlight_2__c, Teaser_Highlight_3__c, Betreiber__r.Id, Betreiber__r.Name, Betreiber__r.Stra_e__c, Betreiber__r.PLZ__c, Betreiber__r.Stadt__c, Betreiber__r.Betreiber_Logo__c, Betreiber__r.Betreiberinformationen__c, (SELECT Id, Name, Area_sq_m__c, Purchase_Price__c, Purchase_Price_sq_m__c, Status__c FROM Appartments__r ORDER BY Name) FROM Property__c WHERE (Is_Public__c = true AND Status_Reason__c = 'Aktiv') ORDER BY Name];

                List<Property__c> propsNormal2 = [SELECT Id, Vertrieben_durch__c , Notar__r.Account.Name, InstandhaltungOnce__c ,In_Vorschau__c, Vorschau_Apartments__c, Vorschau_Fertigstellung__c, Vorschau_Fl_che__c, Vorschau_Kaufpreis__c, Vorschau_Rendite__c, Afa_Facility__c, Afa_Outdoor__c, Afa_Building_Shares__c, In_HypoServ__c, Immorechner_Deaktivieren__c, Finanzierungsbeginn__c, Status_Teilungserkl_rung__c, Hinweis_Kaufpreiszahlung__c, Projektbeauftragte__c, Projektbeauftragte__r.Name, Projektbeauftragte__r.Contact__r.Email, Projektbeauftragte__r.Bild_Datei__c, Projektbeauftragte__r.Foto_URL__c, Projektbeauftragte__r.Telefonnummer__c,Projektbeauftragte_Hyposerv__c, Projektbeauftragte_Hyposerv__r.Name, Projektbeauftragte_Hyposerv__r.Contact__r.Email, Projektbeauftragte_Hyposerv__r.Bild_Datei__c, Projektbeauftragte_Hyposerv__r.Foto_URL__c, Projektbeauftragte_Hyposerv__r.Telefonnummer__c, Text_Nachtrag_Provision__c, Wert_Einrichtung__c,Building_Share_Value__c,Value_Of_Outdoor__c, Beurkundbar_ab__c,Status_Grundrisse__c,Nachtrag_n_tig__c,Nachtrag_Provision__c,Finanzierungslinie_Zinssatz__c, Finanzierungslinie_Zinsbindung__c, Finanzierungslinie_Laufzeit_max__c, Finanzierungslinie_Sondertilgung__c, Finanzierungslinie_Bereitstellungszins__c, Finanzierungslinie_Kaufpreis_max__c, Finanzierungslinie_Informationen__c,Status_Energieausweis__c,Status_Pachtvertrag__c,Status_Anschlusspachtvertrag__c,Status_Patronatserkl_rung__c,Status_Verwaltervertrag__c,Status_Kaufvertrag__c,Status_Grunddienstbarkeit__c,Status_Baubeschreibung__c,Status_Exposee__c,Status_Factsheet__c, Name, Fl_che_ab__c, Finanzierung_Details__c, Fl_che_bis__c, Min_Rendite__c, Max_Rendite__c, Rendite_in__c, Preis_ab__c, Preis_bis__c, Property__c, Bauart__c, Completion__c, MaBV__c, Infozeile_1__c, Arrival__c, Objektvideo_Link__c, Logo__c, Collection_Id_Hyposerv__c, Collection_Id__c, Provisionsbedingung_Check__c, Description__c, Lagebeschreibung__c, Street__c, Zip_Code__c, Place__c, State__c, Teaser_Highlight_1__c, Teaser_Highlight_2__c, Teaser_Highlight_3__c, Betreiber__r.Id, Betreiber__r.Name, Betreiber__r.Stra_e__c, Betreiber__r.PLZ__c, Betreiber__r.Stadt__c, Betreiber__r.Betreiber_Logo__c, Betreiber__r.Betreiberinformationen__c, (SELECT Id, Name, Area_sq_m__c, Purchase_Price__c, Purchase_Price_sq_m__c, Status__c FROM Appartments__r ORDER BY Name) FROM Property__c WHERE Id in (SELECT Immobilie__c FROM Exklusiv_im_ImmoFinder__c WHERE Account_ID__c = :user.AccountId__c) ORDER BY Name];

                Set<Property__c> propsSet = new Set<Property__c>();
                propsSet.addAll(propsNormal);
                propsSet.addAll(propsNormal2);
                properties.addAll(propsSet);
                properties.sort();
            } else {
                properties = [SELECT Id, Vertrieben_durch__c, Notar__r.Account.Name, In_Vorschau__c, Vorschau_Apartments__c, Vorschau_Fertigstellung__c, Vorschau_Fl_che__c, Vorschau_Kaufpreis__c, Vorschau_Rendite__c, Afa_Facility__c, Afa_Outdoor__c, Afa_Building_Shares__c, In_HypoServ__c, Name, Immorechner_Deaktivieren__c, Finanzierungsbeginn__c, Status_Teilungserkl_rung__c, Hinweis_Kaufpreiszahlung__c, Projektbeauftragte__c, Projektbeauftragte__r.Name, Projektbeauftragte__r.Contact__r.Email, Projektbeauftragte__r.Bild_Datei__c, Projektbeauftragte__r.Foto_URL__c, Projektbeauftragte__r.Telefonnummer__c, Projektbeauftragte_Hyposerv__c, Projektbeauftragte_Hyposerv__r.Name, Projektbeauftragte_Hyposerv__r.Contact__r.Email, Projektbeauftragte_Hyposerv__r.Bild_Datei__c, Projektbeauftragte_Hyposerv__r.Foto_URL__c, Projektbeauftragte_Hyposerv__r.Telefonnummer__c,Status_Grundrisse__c, Text_Nachtrag_Provision__c, Wert_Einrichtung__c,Building_Share_Value__c,Value_Of_Outdoor__c, Beurkundbar_ab__c,Nachtrag_n_tig__c,Nachtrag_Provision__c,Finanzierungslinie_Zinssatz__c, Finanzierungslinie_Zinsbindung__c, Finanzierungslinie_Laufzeit_max__c, Finanzierungslinie_Sondertilgung__c, Finanzierungslinie_Bereitstellungszins__c, Finanzierungslinie_Kaufpreis_max__c, Finanzierungslinie_Informationen__c,Status_Energieausweis__c,Status_Pachtvertrag__c,Status_Anschlusspachtvertrag__c,Status_Patronatserkl_rung__c,Status_Verwaltervertrag__c,Status_Kaufvertrag__c,Status_Grunddienstbarkeit__c,Status_Baubeschreibung__c,Status_Exposee__c,Status_Factsheet__c, Fl_che_ab__c, Finanzierung_Details__c, Fl_che_bis__c, Min_Rendite__c, Max_Rendite__c, Rendite_in__c, Preis_ab__c, Preis_bis__c, Property__c, Bauart__c, Completion__c, MaBV__c, Infozeile_1__c, Arrival__c, Objektvideo_Link__c, Logo__c, Collection_Id_Hyposerv__c, Collection_Id__c, Provisionsbedingung_Check__c, Description__c, Lagebeschreibung__c, Street__c, Zip_Code__c, Place__c, State__c, Teaser_Highlight_1__c, Teaser_Highlight_2__c, Teaser_Highlight_3__c, Betreiber__r.Id, Betreiber__r.Name, Betreiber__r.Stra_e__c, Betreiber__r.PLZ__c, Betreiber__r.Stadt__c, Betreiber__r.Betreiber_Logo__c, Betreiber__r.Betreiberinformationen__c, (SELECT Id, Name, Area_sq_m__c, Purchase_Price__c, Purchase_Price_sq_m__c, Status__c FROM Appartments__r ORDER BY Name) FROM Property__c WHERE (Is_Public__c = true AND Status_Reason__c = 'Aktiv') ORDER BY Name];

            }
            return properties;
        }

    }



}